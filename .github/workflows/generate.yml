# This is a basic workflow to help you get started with Actions

name: Генерация артефактов из Protobuf

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: [ "master" ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - name: Выгрузка кода
      uses: actions/checkout@v2
      
    - name: Настройка Go
      uses: actions/setup-go@v2
      with:
        go-version: '1.23.3'
        
    - name: Установка компилятора Protobuf
      run: |
        PB_REL="https://github.com/protocolbuffers/protobuf/releases"
        curl -LO $PB_REL/download/v25.1/protoc-25.1-linux-x86_64.zip
        unzip protoc-25.1-linux-x86_64.zip -d $HOME/.local
        rm protoc-25.1-linux-x86_64.zip
        export PATH="$PATH:$HOME/.local/bin"
        echo 'export PATH="$PATH:$HOME/.local/bin"' >> ~/.bashrc
        source ~/.bashrc
        
    - name: Установка protoc-gen-go
      run: go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

    - name: Установка protoc-gen-go-grpc
      run: go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

    - name: Генерация Go-кода
      run: protoc --go_out=. --go-grpc_out=. *.proto

    - name: Архивирование Go-артефактов
      uses: actions/upload-artifact@v2
      with:
        name: go-artifacts
        path: ./*.pb.go
